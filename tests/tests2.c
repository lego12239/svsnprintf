/*
 * %f tests from glibc stdio-common/tfformat.c.
 */
#include <stdio.h>
#include <string.h>
#include <errno.h>
#include "../svsnprintf.c"


#define TERR_OUT(fmt, ...) fprintf(stderr, "%s:%u: " fmt "\n", \
  __FILE__, __LINE__, ##__VA_ARGS__)


struct sprint_double_type {
  int line;
  double value;
  const char *result;
  const char *format_string;
};

struct sprint_double_type tests[] = {
	{__LINE__, 30.3,    "< +30.3000000000>", "<%+15.10f>"},
	{__LINE__, 10.0,    "<10.00>", "<%5.2f>"},
	{__LINE__, 1.002121970718271e+05,    "100212.19707   ", "%0-15.5f"},
	{__LINE__, -1.002121970718271e+05,    "-100212.19707  ", "%0-15.5f"},
	{__LINE__, 1.002121970718271e+05,    "000100212.19707", "%015.5f"},
	{__LINE__, -1.002121970718271e+05,    "-00100212.19707", "%015.5f"},
	{__LINE__, 1.002121970718271e+05,    "+00100212.19707", "%+015.5f"},
	{__LINE__, -1.002121970718271e+05,    "-00100212.19707", "%+015.5f"},
	{__LINE__, 1.002121970718271e+05,    " 00100212.19707", "% 015.5f"},
	{__LINE__, 1.002121970718271e+05,    "+00100212.19707", "% +015.5f"},
	{__LINE__, 1.002121970718271e+05,    "+00100212.19707", "%+ 015.5f"},
	{__LINE__, -1.002121970718271e+05,    "-00100212.19707", "% 015.5f"},
	{__LINE__, 1.002121970718271e+05,    "+100212.19707  ", "%+-15.5f"},
	{__LINE__, -1.002121970718271e+05,    "-100212.19707  ", "%+-15.5f"},
	{__LINE__, -1.003238744365917e-23,    "-0.00", "%4.2f"},
	{__LINE__, -1.005084840877781e-29,    "  -0", "%4.f"},
	{__LINE__, -1.009390937771849e+15,    "-1009390937771849.000000", "%+f"},
	{__LINE__, -1.010679382726182e-29,    "-0.0000000", "%.7f"},
	{__LINE__, -1.010691853346650e+13,    "-10106918533466.500000", "%+f"},
	{__LINE__, -1.019269582113858e-25,    "  -0", "%4.0f"},
	{__LINE__, -1.021037413548719e+02,    "-102.103741", "%f"},
	{__LINE__, -1.024736652408627e+10,    "-10247366524.086269", "%+f"},
	{__LINE__, -1.027080247585776e-04,    "-0.0001027", "%6.7f"},
	{__LINE__, -1.034347730570491e+16,    "-10343477305704910.000000", "%+f"},
	{__LINE__, -1.034843152721857e-14,    "    -0", "%6.f"},
	{__LINE__, -1.038563976775690e-12,    "-0.000000", "%f"},
	{__LINE__, -1.046306092899333e-06,    "-0.00", "%0.2f"},
	{__LINE__, -1.051739652002504e-28,    "-0.000000", "%+f"},
	{__LINE__, -1.057180924868704e+15,    "-1057180924868704", "%4.f"},
	{__LINE__, -1.063734263253492e-13,    "-0.000000", "%0f"},
	{__LINE__, -1.068401334996592e-12,    "-0.0000000", "%+.7f"},
	{__LINE__, -1.069451976810790e+16,    "-10694519768107900.000000", "%f"},
	{__LINE__, -1.079352432833170e+11,    "-107935243283", "%+2.f"},
	{__LINE__, -1.081431147440215e+16,    "-10814311474402150.000000", "%+f"},
	{__LINE__, -1.093647615472090e+06,    "-1093647.61547", "%6.5f"},
	{__LINE__, -1.124243676139007e-07,    "-0.000000", "%f"},
	{__LINE__, -1.141182595083699e-18,    "-0.000000", "%f"},
	{__LINE__, -1.143199141708028e+18,    "-1143199141708028032", "%2.f"},
	{__LINE__, -1.146712902056139e+21,    "-1146712902056139030528.000000", "%f"},
	{__LINE__, -1.146837903839073e-02,    " -0.0", "%+5.1f"},
	{__LINE__, -1.149575523465052e+20,    "-114957552346505199616.00000", "%+.5f"},

	{__LINE__, -1.162293536734798e+10,    "-11622935367.347980", "%f"},
	{__LINE__, -1.166448459023264e-08,    "-0.000000", "%f"},
	{__LINE__, -1.169901754818745e-28,    "-0.000000", "%+f"},
	{__LINE__, -1.177268411775439e-05,    "-0.000012", "%#2.6f"},
	{__LINE__, -1.196559413116537e-28,    "-0.000000", "%6.6f"},
	{__LINE__, -1.200279514790649e-25,    "-0.0000", "%0.4f"},
	{__LINE__, -1.210189135822574e+01,    "-12", "%+2.0f"},
	{__LINE__, -1.214096815259005e+17,    "-121409681525900496.000000", "%f"},
	{__LINE__, -1.220824440193375e-02,    "-0.012208", "%4f"},
	{__LINE__, -1.228469080229780e-02,    "-0.012285", "%0f"},
	{__LINE__, -1.233381256982191e-26,    "-0.000000", "%f"},
	{__LINE__, -1.245992228426733e-24,    "-0.000000", "%f"},
	{__LINE__, -1.246498277739883e-12,    "-0.0000000", "%5.7f"},
	{__LINE__, -1.252630814464822e-02,    "-0.012526", "%+f"},
	{__LINE__, -1.253076368257011e-28,    "-0.000000", "%f"},
	{__LINE__, -1.258041911573120e+06,    "-1258041.911573", "%+f"},
	{__LINE__, -1.261670983426507e-25,    "-0.00", "%.2f"},
	{__LINE__, -1.266977908502326e+06,    "-1266978", "%+1.f"},
	{__LINE__, -1.278855081807602e+15,    "-1278855081807602.00000", "%#0.5f"},
	{__LINE__, -1.282331291499203e+14,    "-128233129149920.296875", "%+f"},
	{__LINE__, -1.297801639022777e+23,    "-129780163902277691637760.00000", "%#0.5f"},
	{__LINE__, -1.312070555198201e+26,    "-131207055519820092140421120", "%+7.f"},
	{__LINE__, -1.313087359008389e-23,    "-0.000000", "%+f"},
	{__LINE__, -1.319603985988120e+29,    "-131960398598812007412074020864.000000", "%f"},
	{__LINE__, -1.332751724965715e+22,    "-13327517249657150373888.000000", "%f"},
	{__LINE__, -1.333194379353273e-19,    "-0.000000", "%f"},
	{__LINE__, -1.339117288874809e-03,    "-0.001", "%1.3f"},
	{__LINE__, -1.341953272572953e-19,    "-0.000000", "%+f"},
	{__LINE__, -1.354066549307666e-12,    "    -0", "%+6.f"},
	{__LINE__, -1.357278618897291e+19,    "-13572786188972910592.000000", "%f"},
	{__LINE__, -1.357537331348202e-10,    "-0.000", "%+.3f"},
	{__LINE__, -1.360011287595868e-10,    "-0.000000", "%f"},
	{__LINE__, -1.366667926615127e+08,    "-136666792.661513", "%f"},
	{__LINE__, -1.378351117694958e-13,    "-0.000000", "%f"},
	{__LINE__, -1.380380583822272e-17,    "-0.000000", "%+f"},
	{__LINE__, -1.390880300369347e+03,    "-1390.880300", "%f"},
	{__LINE__, -1.397458546930799e+21,    "-1397458546930799083520.000000", "%f"},
	{__LINE__, -1.398809636136688e-16,    "-0.000000", "%+f"},
	{__LINE__, -1.400102603335755e+20,    "-140010260333575503872.000000", "%2f"},
	{__LINE__, -1.411680434455781e+28,    "-14116804344557811000340905984.000000", "%f"},
	{__LINE__, -1.418468741386300e+09,    "-1418468741.386300", "%f"},
	{__LINE__, -1.423675488122461e+18,    "-1423675488122460928.000000", "%f"},
	{__LINE__, -1.439494412124925e+13,    "-14394944121249.250000", "%f"},
	{__LINE__, -1.440032823245152e+10,    "-14400328232.451521", "%f"},
	{__LINE__, -1.440174494009562e-08,    "-0.000000", "%7f"},
	{__LINE__, -1.444655304181403e+10,    "-14446553041.814030", "%7f"},
	{__LINE__, -1.447795251395321e-04,    "-0.000145", "%+f"},
	{__LINE__, -1.451269763513571e+10,    "-14512697635.135710", "%6f"},
	{__LINE__, -1.452753650285897e+21,    "-1452753650285897056256.000000", "%5f"},
	{__LINE__, -1.469271519834567e+20,    "-146927151983456698368", "%+.0f"},
	{__LINE__, -1.507054033750081e-22,    "-0.000000", "%f"},
	{__LINE__, -1.514959134622707e-18,    "-0.000000", "%+f"},
	{0, 0, NULL, NULL}
};

int
main(int argc, char **argv)
{
	int i, cnt, ret, total = 0;
	char buf[1024];

	for(i = 0; tests[i].line; i++)
		total++;

	for(i = 0, cnt = 0; tests[i].line; i++) {
		ret = ssnprintf(buf, 1024, tests[i].format_string, tests[i].value);
		if (ret >= 1024) {
			TERR_OUT("ret is %d", ret);
			break;
		}
		if (strcmp(buf, tests[i].result) != 0) {
			TERR_OUT("test at line %d fail: %s\n", tests[i].line, buf);
			continue;
		}
		cnt++;
	}

	printf("TOTAL %d/%d\n", cnt, total);
	return cnt == total ? 0 : 1;
}
